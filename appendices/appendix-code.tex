\section{Coding}\label{code}
In this Appendix we reproduce all the quantities  that should be coded.

Eqs.~\eqref{calvimchiewn}, \eqref{calvimchie2wn}, and \eqref{calvimchiwn}
\eqref{calvimchi2wn}
\begin{align}\label{c-calvimchiewn}
\mathrm{Im}[\chi_{e,\rma\rmb\rmc,\go}^{S,\ell}] =
-\frac{\pi |e|^3}{2\hbar^2}\sum_{vc\bfk}\sum_{l\neq(v,c)}\frac{1}{\omega^{\gs}_{cv}}
\left[
\frac{\mathrm{Im}[\mathcal{V}^{\gs,\text{a},\ell}_{lc}\{r^{\rmb}_{cv}r^{\rmc}_{vl}\}]}
{(2\go^\gs_{cv}-\go^\gs_{cl})} 
-\frac{\mathrm{Im}[\mathcal{V}^{\gs,\text{a},\ell}_{vl}\{r^{\rmc}_{lc}r^{\rmb}_{cv}\}]}
{(2\go^\gs_{cv}-\go^\gs_{lv})}
\right]\gd(\go^\gs_{cv}-\go),
\end{align}  
\begin{align}\label{c-calvimchie2wn}
\mathrm{Im}[\chi_{e,\rma\rmb\rmc,2\go}^{S,\ell}] =
-\frac{\pi |e|^3}{2\hbar^2}\sum_{vc\bfk}\frac{4}{\omega^{\gs}_{cv}}
\left[
\sum_{v'\ne
  v}\frac{\mathrm{Im}[\mathcal{V}^{\gs,\text{a},\ell}_{vc}\{r^{\rmb}_{cv'}r^{\rmc}_{v'v}\}]}
{2\go^\gs_{cv'}-\go^\gs_{cv}}
- \sum_{c'\ne
  c}\frac{\mathrm{Im}[\mathcal{V}^{\gs,\text{a},\ell}_{vc}\{r^{\rmc}_{cc'}r^{\rmb}_{c'v}\}]}
{2\go^\gs_{c'v}-\go^\gs_{cv}}
\right]\gd(\go^\gs_{cv}-2\go),
\end{align}
\begin{align}\label{c-calvimchiwn}
\mathrm{Im}[\chi_{i,\text{a}\text{b}\text{c},\omega}^{S,\ell}]
= -\frac{\pi\vert e\vert^3}{2\hbar^2}\sum_{cv\mathbf{k}}\frac{1}{(\omega^{\gs}_{cv})^{2}}
\left(
\mathrm{Re}\left[r^{\text{b}}_{cv}\left(\mathcal{V}^{\gs,\text{a},\ell}_{vc}\right)_{;k^{\text{c}}}\right]
+\frac{\,\mathrm{Re}\left[\mathcal{V}^{\gs,\text{a},\ell}_{vc}r^{\text{b}}_{cv}\right]
\Delta^{\text{c}}_{cv}}{\omega^{\gs}_{cv}} 
\right)\delta(\omega^{\gs}_{cv}-\omega),
\end{align}
and
\begin{align}\label{c-calvimchi2wn}
\mathrm{Im}[\chi_{i,\text{a}\text{b}\text{c},2\omega}^{S,\ell}] 
=
 -\frac{\pi \vert
   e\vert^{3}}{2\hbar^2}\sum_{vc\mathbf{k}}\frac{4}{(\omega^{\gs}_{cv})^{2}}
\left(\mathrm{Re}\left[\mathcal{V}^{\gs,\text{a},\ell}_{vc}\left(r^{\text{b}}_{cv}\right)_{;k^{\text{c}}}
\right] -
\frac{2\,\mathrm{Re}\left[\mathcal{V}^{\gs,\text{a},\ell}_{vc}r^{\text{b}}_{cv}\right]
\Delta^{\text{c}}_{cv}}{\omega^{\gs}_{cv}}\right)\delta(\omega^{\gs}_{cv}-2\omega).
\end{align}
To evaluate above expressions we need the following ($m_e=1$):
\begin{align}\label{}
\bfv^\lda_{nm}(\bfk) 
=(1/m_e)\bfp_{nm}(\bfk)+\bfv^\nl_{nm}(\bfk)
=\bfp_{nm}(\bfk)+\bfv^\nl_{nm}(\bfk)
,
\end{align}
that
 includes the local and nonlocal parts of the pseudopotential. They
 correspond to the following files:\\
$\bullet$ $\bfp_{nm}(\bfk)\to$ \verb=me_pmn_*=\\
$\bullet$ $\bfv^\nl_{nm}(\bfk)\to$ \verb=me_vnlnm_*=\\
where the \verb=nm= or \verb=mn= order in the files is irrelevant, and
ought to be fixed just for the {\it biuty} of it.
Option \verb=-n= in \verb=all_responses.sh= adds above files, so   
$\bfv^\lda_{nm}(\bfk)$
 is available in the code. 
Then,
\begin{align}\label{c-chon.98}
\bfr_{nm}(\bfk)=\frac{\bfv^\lda_{nm}(\bfk)}{i\go^\lda_{nm}(\bfk)}
\quad\quad n\ne m
,
\end{align}   
is also available. 
If option \verb=-n= is not chosen, then the contribution of $\bfv^\nl_{nm}(\bfk)$
is neglected in the calculation of any response. Obviously, in this
case the code only uses \verb=me_pmn_*=.

We need Eq.~\eqref{a.1} and \eqref{a.2}
\begin{align}\label{c-a.1}
\calv^{\gs,\rma,\ell}_{nm}
&=
\calv^{\lda,\rma,\ell}_{nm}
+
\calv^{\cals,\rma,\ell}_{nm}
\nonumber\\
\left(
\calv^{\gs,\rma,\ell}_{nm}
\right)_{;k^\rmb}
&=
\left(
\calv^{\lda,\rma,\ell}_{nm}
\right)_{;k^\rmb}
+
\left(
\calv^{\cals,\rma,\ell}_{nm}
\right)_{;k^\rmb}
.
\end{align}
 The first LDA term is
\begin{align}\label{c-a.2}
\calv^{\lda,\rma,\ell}_{nm}
&=
\frac{1}{2}\sum_q\left(
v^{\lda,\rma}_{nq}\calc^\ell_{qm}+\calc^\ell_{nq} v^{\lda,\rma}_{qm}
\right)
.
\end{align} 
If option \verb=-n= is not chosen in \verb=all_responses.sh= above is
not calculated and\\
$\bullet$ $\calv^{\lda,\rma,\ell}_{nm}\to$ \verb=me_cpmn_*=\\ 
If option \verb=-n= is chosen above expresion must be calculated in
\verb=set_input_ascii.f90=. We mention that
$\calv^{\lda,\rma,\ell}_{nm}$ can be computed directly,\cite{nicolaspc}
avoiding the sum over the full set of bands $q$, however we chose this route.
Then, we need 
Eq.~\eqref{eni.4}
\begin{align}\label{c-eni.4}
\calc^\ell_{nm}(\bfk)=
\sum_{\bfG,\bfG'} A^*_{n\bfk}(\bfG')  A_{m\bfk}(\bfG)
\gd_{\bfG_\parallel \bfG'_\parallel}
f_\ell(G_\perp-G'_\perp)
.
\end{align} 
which is coded in \verb=sub_pmn_ascii.f90= within the same subroutine of $\calbv^\ell_{nm}$
calculated with Eq.~\eqref{eni.2}.

 The second LDA term is
\begin{align}\label{c-a.2n}
\left(\calv^{\lda,\rma,\ell}_{nm}\right)_{;k^\rmb}
&=
\frac{1}{2}\sum_q\left(
(v^{\lda,\rma}_{nq})_{;k^\rmb}\calc^\ell_{qm}
+ 
v^{\lda,\rma}_{nq}(\calc^\ell_{qm})_{;k^\rmb}
+
(\calc^\ell_{nq})_{;k^\rmb} v^{\lda,\rma}_{qm}
+
\calc^\ell_{nq} (v^{\lda,\rma}_{qm})_{;k^\rmb}
\right)
,
\end{align} 
where\\
$\bullet$ for $n\ne m$\\
Eq.~\eqref{a.3}
\begin{align}\label{c-a.3}
(v^{\lda,\rma}_{nm})_{;k^\rmb}
&=  
im_e\gD^b_{nm}r^\rma_{nm}
+ 
im_e\go^\lda_{nm}(r^\rma_{nm})_{;k^\rmb}
\quad\mathrm{for}\quad n\ne m
,
\end{align} 
with
Eq.~\eqref{eli.13}
\begin{align}\label{c-eli.13}
\gD_{nm}^{\rma}
=
v_{nn}^{\lda,\rma}-v_{mm}^{\lda,\rma}
,
\end{align}
and \eqref{na_rgendevn}
\begin{align}\label{c-na_rgendevn}
(r^{\rmb}_{nm})_{;k^{\rma}}
&=
-i\calt^{\rma\rmb}_{nm}
+
\frac{
r^{\rma}_{nm}
\Delta^{\rmb}_{mn}
+r^{\rmb}_{nm}
\Delta^{\rma}_{mn}
}
{\go^\lda_{nm}}
+
\frac{i}{\go^\lda_{nm}}
\sum_{\ell}
\bigg(
\go^\lda_{\ell m}
r^{\rma}_{n\ell}
r^{\rmb}_{\ell m}
-
\go^\lda_{n\ell}
r^{\rmb}_{n\ell}
r^{\rma}_{\ell m}
\bigg)
\nonumber\\
&\approx
\frac{
r^{\rma}_{nm}
\Delta^{\rmb}_{mn}
+r^{\rmb}_{nm}
\Delta^{\rma}_{mn}
}
{\go^\lda_{nm}}
+
\frac{i}{\go^\lda_{nm}}
\sum_{\ell}
\bigg(
\go^\lda_{\ell m}
r^{\rma}_{n\ell}
r^{\rmb}_{\ell m}
-
\go^\lda_{n\ell}
r^{\rmb}_{n\ell}
r^{\rma}_{\ell m}
\bigg)
,
\end{align}
where $\calt^{\rma\rmb}_{nm}\approx 0$.\\
$\bullet$ for $n=m$\\
Since 
$\calt^{\rma\rmb}_{nn}\approx (\hbar/m_e)\gd_{\rma\rmb}$,
Eq.~\eqref{a.3c} gives
\begin{align}\label{c-a.3c}
(v^{\lda,\rma}_{nn})_{;k^\rmb}
&=
-i\calt^{\rma\rmb}_{nn}
-
\sum_{\ell\ne n}
\go^\lda_{\ell n}
\bigg( 
r^{\rma}_{n\ell} 
r^\rmb_{\ell n}
+ 
r^\rmb_{n\ell} 
r^{\rma}_{\ell n}
\bigg)
\nonumber\\
&\approx
\frac{\hbar}{m_e}\gd_{\rma\rmb}
-
\sum_{\ell\ne n}
\go^\lda_{\ell n}
\bigg( 
r^{\rma}_{n\ell} 
r^\rmb_{\ell n}
+ 
r^\rmb_{n\ell} 
r^{\rma}_{\ell n}
\bigg)
.
\end{align} 
For Eq.~\eqref{c-a.2n} we need
\eqref{a.7}
\begin{align}\label{c-a.7}
 (\calc^\ell_{nm})_{;\bfk}
&=
i\sum_{q\ne nm}
\left(
r_{nq}^\rma
\calc^\ell_{qm}
-
\calc^\ell_{nq}
r_{qm}^\rma
\right)
+ir_{nm}^\rma(\calc^\ell_{mm}-\calc^\ell_{nn})
.
\end{align} 

For the scissor related term we have:
Eq.~\eqref{a.3b} , \eqref{choni.1} and \eqref{chon.2}
\begin{align}\label{c-a.3b}
\calv^{\cals,\rma,\ell}_{nm}
&=
\frac{1}{2}\sum_q\left( 
v^{\cals,\rma}_{nq}\calc^\ell_{qm}+\calc^\ell_{nq} v^{\cals,\rma}_{qm}
\right)
\nonumber\\
\left(\calv^{\cals,\rma}_{nm}\right)_{;k^\rmb}
&=
\frac{1}{2}\sum_q\left(
(v^{\cals,\rma}_{nq})_{;k^\rmb}\calc^\ell_{qm}
+  
v^{\cals,\rma}_{nq}(\calc^\ell_{qm})_{;k^\rmb}
+
(\calc^\ell_{nq})_{;k^\rmb} v^{\cals,\rma}_{qm}
+
\calc^\ell_{nq} (v^{\cals,\rma}_{qm})_{;k^\rmb}
\right)
,
\end{align}  
with Eqs.~\eqref{chon.2} and \eqref{choni.1}
\begin{align}\label{c-chon.2} 
v^{\cals,\rma}_{nm}=i\gS f_{mn}r^\rma_{nm}
,
\end{align}
\begin{align}\label{c-choni.1}
(v^{\cals,\rma}_{nm})_{;k^\rmb}=i\gS f_{mn}
(r^\rma_{nm})_{;k^\rmb}
,
\end{align}
where $\hbar\gS$ is the scissors correction.



\subsubsection{Consistency check-up}

To check that the coding of 
$\calc^\ell_{nm}(\bfk)$ 
is correct, we can calculate $\calv^{\rma,\ell}_{nm}(\bfk)$ using
Eq.~\eqref{vcali} as follows
\begin{align}\label{ccu.1}
\calv^{\rma,\ell}_{nm}(\bfk)
&=
\frac{1}{2m_e}
\Big(
\calc^\ell(z)p^\rma
+
p^\rma\calc^\ell(z)
\Big)_{nm}
\nonumber\\
&=
\frac{1}{2m_e}
\sum_q
\Big(
\calc^\ell_{nq}p^\rma_{qm}
+
p^\rma_{nq}\calc^\ell_{qm}
\Big)
,
\end{align}
which must give the same results as those computed through
Eq.~\eqref{eni.2}.
Indeed, we have checked that this is the case. The
\verb=consistency-of-cfmn.f90=
was used to check this.
